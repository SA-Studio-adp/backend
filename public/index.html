<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>SC Files Admin</title>
    <style>
        body { font-family: sans-serif; max-width: 900px; margin: 40px auto; padding: 20px; background: #f4f4f4; }
        .card { background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input, select, button { width: 100%; padding: 10px; margin: 8px 0; box-sizing: border-box; }
        .row { display: flex; gap: 10px; align-items: center; }
        button { background: #007bff; color: white; border: none; cursor: pointer; font-weight: bold; }
        .btn-fetch { background: #28a745; width: 120px; }
        .btn-delete { background: #dc3545; width: auto; padding: 5px 10px; }
        .btn-edit { background: #ffc107; color: black; width: auto; padding: 5px 10px; margin-right: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #ddd; }
        .nav { display: flex; justify-content: space-between; margin-bottom: 20px; }
    </style>
</head>
<body>
    <div class="nav">
        <h2>ðŸŽ¬ SC Files Manager</h2>
        <a href="/logs.html" style="margin-top: 10px;">View Logs</a>
    </div>

    <div class="card">
        <h3 id="formTitle">Add Movie</h3>
        <form id="movieForm">
            <div class="row">
                <input type="number" id="tmdb_id" placeholder="TMDB ID" required>
                <button type="button" class="btn-fetch" onclick="generateSlug()">Fetch Info</button>
            </div>
            <input type="text" id="movie_id" placeholder="Auto-generated Slug (e.g., the-dark-knight)" required>
            <input type="text" id="extras" placeholder="Extras (e.g. Tamil Audio)">
            <select id="pos">
                <option value="">Standard Position</option>
                <option value="top">Top Pick</option>
            </select>
            <input type="url" id="dl_480" placeholder="480p Link" required>
            <input type="url" id="dl_720" placeholder="720p Link" required>
            <input type="url" id="dl_1080" placeholder="1080p Link" required>
            <button type="submit" id="submitBtn">Save Movie</button>
            <button type="button" id="cancelBtn" style="display:none; background:#6c757d;">Cancel Edit</button>
        </form>
    </div>

    <div class="card">
        <h3>Current Movies</h3>
        <table id="movieTable">
            <thead>
                <tr>
                    <th>ID / Slug</th>
                    <th>TMDB</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        let isEditing = false;
        const TMDB_API_KEY = "YOUR_TMDB_API_KEY_HERE"; // Optional: If you have an API key, slugs will be more accurate

        // Helper: Generate URL friendly slug
        function createSlug(text) {
            return text.toString().toLowerCase().trim()
                .replace(/\s+/g, '-')           // Replace spaces with -
                .replace(/[^\w\-]+/g, '')       // Remove all non-word chars
                .replace(/\-\-+/g, '-');        // Replace multiple - with single -
        }

        // Fetch title from TMDB and generate slug
        async function generateSlug() {
            const tmdbId = document.getElementById('tmdb_id').value;
            if (!tmdbId) return alert("Enter TMDB ID first");

            try {
                // Using the free public TMDB helper or your own API key
                const response = await fetch(`https://api.themoviedb.org/3/movie/${tmdbId}?api_key=${TMDB_API_KEY}`);
                if (!response.ok) throw new Error("Movie not found");
                
                const data = await response.json();
                const slug = createSlug(data.title);
                document.getElementById('movie_id').value = slug;
            } catch (err) {
                alert("Could not fetch TMDB data. Please enter slug manually.");
            }
        }

        async function loadMovies() {
            const res = await fetch('/api/movies');
            const movies = await res.json();
            const tbody = document.querySelector('#movieTable tbody');
            tbody.innerHTML = movies.map(m => `
                <tr>
                    <td>${m.id}</td>
                    <td>${m.tmdb_id}</td>
                    <td>
                        <button class="btn-edit" onclick="editMovie('${m.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteMovie('${m.id}')">Delete</button>
                    </td>
                </tr>
            `).join('');
        }

        document.getElementById('movieForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('movie_id').value;
            const data = {
                id: id,
                tmdb_id: parseInt(document.getElementById('tmdb_id').value),
                extras: document.getElementById('extras').value,
                pos: document.getElementById('pos').value || undefined,
                downloads: {
                    480: document.getElementById('dl_480').value,
                    720: document.getElementById('dl_720').value,
                    1080: document.getElementById('dl_1080').value
                }
            };

            const url = isEditing ? `/api/movies/${id}` : '/api/movies';
            const method = isEditing ? 'PUT' : 'POST';

            await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            resetForm();
            loadMovies();
        };

        async function editMovie(id) {
            const res = await fetch('/api/movies');
            const movies = await res.json();
            const movie = movies.find(m => m.id === id);
            
            if (movie) {
                isEditing = true;
                document.getElementById('formTitle').innerText = "Editing: " + id;
                document.getElementById('movie_id').value = movie.id;
                document.getElementById('movie_id').readOnly = true;
                document.getElementById('tmdb_id').value = movie.tmdb_id;
                document.getElementById('extras').value = movie.extras || "";
                document.getElementById('pos').value = movie.pos || "";
                document.getElementById('dl_480').value = movie.downloads[480];
                document.getElementById('dl_720').value = movie.downloads[720];
                document.getElementById('dl_1080').value = movie.downloads[1080];
                document.getElementById('cancelBtn').style.display = "block";
                window.scrollTo(0,0);
            }
        }

        async function deleteMovie(id) {
            if (confirm(`Delete ${id}?`)) {
                await fetch(`/api/movies/${id}`, { method: 'DELETE' });
                loadMovies();
            }
        }

        function resetForm() {
            isEditing = false;
            document.getElementById('movieForm').reset();
            document.getElementById('movie_id').readOnly = false;
            document.getElementById('formTitle').innerText = "Add Movie";
            document.getElementById('cancelBtn').style.display = "none";
        }

        document.getElementById('cancelBtn').onclick = resetForm;
        loadMovies();
    </script>
</body>
</html>
