<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel</title>
    <style>
        :root { --primary: #007bff; --success: #28a745; --danger: #dc3545; --warning: #ffc107; }
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 900px; margin: 0 auto; padding: 15px; background: #f4f7f6; color: #333; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; box-sizing: border-box; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { background: var(--primary); color: white; border: none; cursor: pointer; font-weight: bold; }
        .btn-delete { background: var(--danger); width: auto; }
        .btn-edit { background: var(--warning); color: black; width: auto; }
        .nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .nav a { text-decoration: none; color: var(--primary); font-weight: bold; }
        table { width: 100%; border-collapse: collapse; }
        th, td { text-align: left; padding: 12px; border-bottom: 1px solid #eee; }
        #slug-status { font-size: 12px; color: #666; }

        @media (max-width: 600px) {
            table, thead, tbody, th, td, tr { display: block; }
            tr { border: 1px solid #ddd; margin-bottom: 10px; border-radius: 8px; padding: 10px; }
            td { border: none; text-align: right; padding-left: 50%; position: relative; }
            td:before { content: attr(data-label); position: absolute; left: 10px; font-weight: bold; }
        }
    </style>
</head>
<body>
    <div class="nav">
        <h2>ðŸŽ¬ Files Manager</h2>
        <a href="/logs.html">View Logs</a>
    </div>

    <div class="card">
        <h3 id="formTitle">Add Movie</h3>
        <form id="movieForm">
            <input type="number" id="tmdb_id" placeholder="Enter TMDB ID" required>
            <small id="slug-status">Slug generates as you type...</small>
            <input type="text" id="movie_id" placeholder="Movie ID (Slug)" required>
            <input type="text" id="extras" placeholder="Extras (e.g. Tamil Audio)">
            <input type="url" id="dl_480" placeholder="480p Link" required>
            <input type="url" id="dl_720" placeholder="720p Link" required>
            <input type="url" id="dl_1080" placeholder="1080p Link" required>
            <button type="submit" id="submitBtn">Save Movie</button>
            <button type="button" id="cancelBtn" style="display:none; background:#6c757d;">Cancel</button>
        </form>
    </div>

    <div class="card">
        <table>
            <tbody id="movieList"></tbody>
        </table>
    </div>

    <script>
        let isEditing = false;
        let slugTimeout = null;

        // Auto-Slug logic
        document.getElementById('tmdb_id').addEventListener('input', (e) => {
            if (isEditing) return;
            clearTimeout(slugTimeout);
            const id = e.target.value;
            if (id.length > 2) {
                document.getElementById('slug-status').innerText = "Fetching...";
                slugTimeout = setTimeout(async () => {
                    const res = await fetch(`https://api.themoviedb.org/3/movie/${id}?api_key=d67317159cbc25bdad2a79e81f06265d`);
                    if (res.ok) {
                        const data = await res.json();
                        document.getElementById('movie_id').value = data.title.toLowerCase().replace(/[^\w ]+/g,'').replace(/ +/g,'-');
                        document.getElementById('slug-status').innerText = "âœ… Fetched: " + data.title;
                    }
                }, 800);
            }
        });

        async function loadMovies() {
            const res = await fetch('/api/movies');
            const movies = await res.json();
            document.getElementById('movieList').innerHTML = movies.map(m => `
                <tr>
                    <td data-label="Slug">${m.id}</td>
                    <td data-label="TMDB">${m.tmdb_id}</td>
                    <td data-label="Actions">
                        <button class="btn-edit" onclick="editMovie('${m.id}')">Edit</button>
                        <button class="btn-delete" onclick="deleteMovie('${m.id}')">Del</button>
                    </td>
                </tr>`).join('');
        }

        document.getElementById('movieForm').onsubmit = async (e) => {
            e.preventDefault();
            const id = document.getElementById('movie_id').value;
            const data = {
                id: id,
                tmdb_id: parseInt(document.getElementById('tmdb_id').value),
                extras: document.getElementById('extras').value,
                downloads: {
                    480: document.getElementById('dl_480').value,
                    720: document.getElementById('dl_720').value,
                    1080: document.getElementById('dl_1080').value
                }
            };
            await fetch(isEditing ? `/api/movies/${id}` : '/api/movies', {
                method: isEditing ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            resetForm(); loadMovies();
        };

        async function editMovie(id) {
            const res = await fetch('/api/movies');
            const movies = await res.json();
            const m = movies.find(x => x.id === id);
            isEditing = true;
            document.getElementById('movie_id').value = m.id;
            document.getElementById('tmdb_id').value = m.tmdb_id;
            document.getElementById('extras').value = m.extras || "";
            document.getElementById('dl_480').value = m.downloads[480];
            document.getElementById('dl_720').value = m.downloads[720];
            document.getElementById('dl_1080').value = m.downloads[1080];
            document.getElementById('cancelBtn').style.display = "block";
            window.scrollTo(0,0);
        }

        async function deleteMovie(id) {
            if(confirm('Delete?')) { await fetch(`/api/movies/${id}`, {method:'DELETE'}); loadMovies(); }
        }

        function resetForm() {
            isEditing = false;
            document.getElementById('movieForm').reset();
            document.getElementById('cancelBtn').style.display = "none";
        }

        // Keep Alive Ping (Every 10 mins for Render)
        setInterval(() => fetch('/api/movies'), 600000);

        loadMovies();
    </script>
</body>
    </html>
